package fr.ynov.dap.web.api;

import java.util.ArrayList;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.google.api.client.util.DateTime;
import com.google.api.services.calendar.model.Event;
import com.google.api.services.calendar.model.EventAttendee;
import com.google.api.services.calendar.model.EventDateTime;

import fr.ynov.dap.services.google.GCalendarService;
import fr.ynov.dap.services.microsoft.MicrosoftCalendarService;

/**
 * CalendarController of the application that uses the Google and the Microsoft API.
 */
@RestController
@RequestMapping("/calendar")
public class CalendarController extends DapController {
    /**
     * Get the google calendar service thanks Spring.
     */
    @Autowired
    private GCalendarService googleCalendarService;

    /**
     * Get the Microsoft calendar thanks to Spring.
     */
    @Autowired
    private MicrosoftCalendarService microsoftCalendarService;

    /**
     * Get the next Event from now.
     * @param userKey user key needed for authentication
     * @return near event from now.
     * It's an object because we can't now if we will get a Google or a Microsoft event.
     * @throws Exception exception
     */
    @RequestMapping(value = "/event/next", method = RequestMethod.GET)
    public Event getNextEvent(@RequestParam("userKey") final String userKey) throws Exception {
        Event googleEvent = googleCalendarService.getNextEventForAllAccount(userKey);
        microsoftCalendarService.setUserKey(userKey);
        fr.ynov.dap.services.microsoft.Event microsoftEvent =
                microsoftCalendarService.getNextEventsOfAllAccount(userKey);

        Event convertedMicrosoftEvent = convertMicrosoftEvent(microsoftEvent);

        if (googleEvent == null && convertedMicrosoftEvent == null) {
            //TODO jaa by Djer |POO| Evite les multiples returns dans une même méthode
            return null;
        }

        if (googleEvent == null && convertedMicrosoftEvent != null) {
            return convertedMicrosoftEvent;
        }

        if (convertedMicrosoftEvent == null && googleEvent != null) {
            return googleEvent;
        }

        //TODO jaa by DJer |API Google| Attention "getStart().getDateTime()" est null pour les évènnements qui durent "toute la journée" (il faut alors utiliser getStart().getDate())
        if (googleEvent.getStart().getDateTime().getValue()
                < convertedMicrosoftEvent.getStart().getDateTime().getValue()) {
            return googleEvent;
        } else {
            return convertedMicrosoftEvent;
        }
    }

    /**
     * Convert a Microsoft event to a Google event. That way, the API with the client will not be broken.
     * @param microsoftEvent the Microsoft Event to convert.
     * @return the converted Microsoft Event to Google Event.
     */
    private Event convertMicrosoftEvent(final fr.ynov.dap.services.microsoft.Event microsoftEvent) {
        if (microsoftEvent == null) {
            return null;
        }

        //TODO jaa by Djer |POO| Evite d'utiliser l'Event d'un autre fournisseur. Créer toi un "Event" générique. En plus tu pourras géré la particularité du getDate() VS getDateTime() de l'API de Google
        Event convertedEvent = new Event();
        convertedEvent.setSummary(microsoftEvent.getSubject());
        long microsoftStartTime = microsoftEvent.getStart().getDateTime().getTime();
        convertedEvent.setStart(new EventDateTime().setDateTime(new DateTime(microsoftStartTime)));
        long microsoftEndTime = microsoftEvent.getEnd().getDateTime().getTime();
        convertedEvent.setEnd(new EventDateTime().setDateTime(new DateTime(microsoftEndTime)));

        //EventAttendee[] attendees = new EventAttendee[1];
        List<EventAttendee> attendees = new ArrayList<EventAttendee>();
        //attendees[0].setOrganizer(microsoftEvent.getIsOrganizer());
        attendees.add(new EventAttendee().setOrganizer(microsoftEvent.getIsOrganizer()));
        convertedEvent.setAttendees(attendees);

        return convertedEvent;
    }
}
